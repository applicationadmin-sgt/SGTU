<!DOCTYPE html>
<html>
<head>
    <title>Security Violation Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .violation-counter { background: #f0f0f0; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .test-buttons button { margin: 5px; padding: 10px 15px; }
        .log { background: #000; color: #0f0; padding: 10px; height: 300px; overflow-y: auto; font-family: monospace; }
    </style>
</head>
<body>
    <h1>Security Violation Counting Test</h1>
    
    <div class="violation-counter">
        <h3>Violation Counts:</h3>
        <div id="counters"></div>
    </div>
    
    <div class="test-buttons">
        <button onclick="simulateTabSwitch()">Simulate Tab Switch</button>
        <button onclick="simulateAltTab()">Simulate Alt+Tab</button>
        <button onclick="simulateFullscreenExit()">Simulate Fullscreen Exit</button>
        <button onclick="clearCounts()">Clear Counts</button>
        <button onclick="testAutoSubmit()">Test Auto Submit Logic</button>
    </div>
    
    <div class="log" id="log"></div>
    
    <script>
        // Simulate the violation tracking system
        let violationAttempts = {
            'tab-switch': 0,
            'alt-tab': 0,
            'fullscreen-exit': 0,
            'window-minimize': 0,
            'suspicious-timing': 0,
            'keyboard-shortcut': 0,
            'context-menu': 0,
            'clipboard': 0,
            'devtools-open-heuristic': 0
        };
        
        let violations = [];
        const MAX_ATTEMPTS = 3;
        
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        function updateCounters() {
            const countersDiv = document.getElementById('counters');
            let html = '';
            for (const [type, count] of Object.entries(violationAttempts)) {
                const color = count >= MAX_ATTEMPTS ? 'red' : count >= 2 ? 'orange' : 'black';
                html += `<div style="color: ${color}"><strong>${type}:</strong> ${count}/${MAX_ATTEMPTS}</div>`;
            }
            html += `<div><strong>Total Violations Array:</strong> ${violations.length}</div>`;
            countersDiv.innerHTML = html;
        }
        
        function addViolation(type, details = {}) {
            const newViolation = { type, details, at: Date.now() };
            violations.push(newViolation);
            log(`🔍 Added violation: ${type} (total: ${violations.length})`);
        }
        
        function showSecurityWarning(violationType, message) {
            log(`🚨 Security Violation: ${violationType} - ${message}`);
            
            // Update violation attempt count for this specific type
            const prevCount = violationAttempts[violationType] || 0;
            const newCount = prevCount + 1;
            violationAttempts[violationType] = newCount;
            
            log(`📊 ${violationType} attempt: ${newCount}/${MAX_ATTEMPTS}`);
            
            // Check if this violation type has reached max attempts
            if (newCount >= MAX_ATTEMPTS) {
                log(`🚫 ${violationType} max attempts reached! Auto-submitting...`);
                
                // Add the final violation that triggered the limit
                const finalViolation = { 
                    type: violationType, 
                    details: { 
                        attempt: newCount,
                        maxAttempts: MAX_ATTEMPTS,
                        message,
                        trigger: 'max_attempts_reached'
                    }, 
                    at: Date.now() 
                };
                violations.push(finalViolation);
                
                // Trigger auto-submit
                setTimeout(() => {
                    triggerAutoSubmit(`Maximum attempts for ${violationType} reached (${newCount}/${MAX_ATTEMPTS})`, violations);
                }, 100);
                
                updateCounters();
                return;
            }
            
            // Add violation to history
            addViolation(violationType, { 
                attempt: newCount,
                maxAttempts: MAX_ATTEMPTS,
                message
            });
            
            updateCounters();
        }
        
        function triggerAutoSubmit(reason, currentViolations) {
            log(`🚨 AUTO-SUBMIT TRIGGERED: ${reason}`);
            
            // Add the auto-submit violation
            const autoSubmitViolation = { type: 'auto-submit', details: { reason }, at: Date.now() };
            const finalViolations = [...currentViolations, autoSubmitViolation];
            
            log(`🔍 Final violations count: ${finalViolations.length}`);
            log(`🔍 Violations: ${finalViolations.map(v => v.type).join(', ')}`);
            
            // Simulate submission
            setTimeout(() => {
                log(`📤 QUIZ SUBMITTED with ${finalViolations.length} violations`);
                log(`📋 Violation types: ${finalViolations.map(v => v.type).join(', ')}`);
            }, 500);
        }
        
        function simulateTabSwitch() {
            showSecurityWarning('tab-switch', 'You switched tabs or windows.');
        }
        
        function simulateAltTab() {
            showSecurityWarning('alt-tab', 'Alt+Tab detected.');
        }
        
        function simulateFullscreenExit() {
            showSecurityWarning('fullscreen-exit', 'You exited fullscreen mode.');
        }
        
        function clearCounts() {
            violationAttempts = {
                'tab-switch': 0,
                'alt-tab': 0,
                'fullscreen-exit': 0,
                'window-minimize': 0,
                'suspicious-timing': 0,
                'keyboard-shortcut': 0,
                'context-menu': 0,
                'clipboard': 0,
                'devtools-open-heuristic': 0
            };
            violations = [];
            document.getElementById('log').innerHTML = '';
            updateCounters();
            log('🔄 Counts cleared');
        }
        
        function testAutoSubmit() {
            log('🧪 Testing auto-submit logic...');
            simulateTabSwitch();
            setTimeout(() => simulateTabSwitch(), 500);
            setTimeout(() => simulateTabSwitch(), 1000);
        }
        
        // Initialize
        updateCounters();
        log('🚀 Security violation test initialized');
    </script>
</body>
</html>